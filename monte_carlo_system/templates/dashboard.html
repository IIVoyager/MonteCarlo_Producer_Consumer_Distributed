<!DOCTYPE html>
<html>
<head>
    <title>Monte Carlo Dashboard</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
        }
        .tab-button.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-wrapper {
            flex: 1;
            min-width: 400px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .system-stats {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .stat-item {
            display: inline-block;
            margin-right: 30px;
            font-size: 14px;
        }
        .stat-value {
            font-weight: bold;
            font-size: 16px;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Monte Carlo Simulation Dashboard</h1>
        
        <div class="system-stats">
            <div class="stat-item">
                <strong>Escenarios Procesados:</strong> 
                <span class="stat-value" id="processedCount">0</span>
            </div>
            <div class="stat-item">
                <strong>Consumidores Activos:</strong> 
                <span class="stat-value" id="activeConsumers">0</span>
            </div>
            <div class="stat-item">
                <strong>Última Actualización:</strong> 
                <span class="stat-value" id="lastUpdate">-</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('progress')">Progreso</button>
            <button class="tab-button" onclick="showTab('consumers')">Consumidores</button>
            <button class="tab-button" onclick="showTab('bitacora')">Bitácora</button>
        </div>

        <!-- Pestaña de Progreso -->
        <div id="progress-tab" class="tab-content active">
            <h2>Progreso de la Simulación</h2>
            <div class="charts-container">
                <div class="chart-wrapper">
                    <h3>Escenarios Generados vs Procesados</h3>
                    <canvas id="progressChart" width="400" height="300"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h3>Distribución por Consumidor</h3>
                    <canvas id="consumerChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Pestaña de Consumidores -->
        <div id="consumers-tab" class="tab-content">
            <h2>Estadísticas de Consumidores</h2>
            <table id="consumerTable">
                <thead>
                    <tr>
                        <th>Consumidor</th>
                        <th>Host</th>
                        <th>Tiempo Activo (s)</th>
                        <th>Escenarios Procesados</th>
                        <th>Último Resultado</th>
                        <th>Última Actividad</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Pestaña de Bitácora -->
        <div id="bitacora-tab" class="tab-content">
            <h2>Bitácora de Procesamiento</h2>
            <table id="bitacoraTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Consumidor</th>
                        <th>Host</th>
                        <th>Resultado</th>
                        <th>Variables del Escenario</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const socket = io();
        let progressChart, consumerChart;
        let progressData = {
            labels: [],
            generated: [],
            processed: []
        };

        socket.on('update', function(data) {
            // Actualizar estadísticas del sistema
            document.getElementById('processedCount').textContent = data.scenarios_processed;
            document.getElementById('activeConsumers').textContent = Object.keys(data.consumer_stats).length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Actualizar gráficas y tablas
            updateProgressChart(data);
            updateConsumerChart(data);
            updateConsumerTable(data);
            updateBitacoraTable(data);
        });

        function showTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Mostrar pestaña seleccionada
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function updateProgressChart(data) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            // Agregar nuevo punto de datos
            const timestamp = new Date().toLocaleTimeString();
            progressData.labels.push(timestamp);
            progressData.generated.push(data.scenarios_generated);
            progressData.processed.push(data.scenarios_processed);
            
            // Mantener solo los últimos 20 puntos
            if (progressData.labels.length > 20) {
                progressData.labels.shift();
                progressData.generated.shift();
                progressData.processed.shift();
            }
            
            if (!progressChart) {
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: progressData.labels,
                        datasets: [
                            {
                                label: 'Escenarios Generados',
                                data: progressData.generated,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Escenarios Procesados',
                                data: progressData.processed,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.1,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad de Escenarios'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tiempo'
                                }
                            }
                        }
                    }
                });
            } else {
                progressChart.data.labels = progressData.labels;
                progressChart.data.datasets[0].data = progressData.generated;
                progressChart.data.datasets[1].data = progressData.processed;
                progressChart.update();
            }
        }

        function updateConsumerChart(data) {
            const ctx = document.getElementById('consumerChart').getContext('2d');
            const consumers = Object.keys(data.consumer_results);
            const results = consumers.map(consumer => data.consumer_results[consumer]);
            
            if (!consumerChart) {
                consumerChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: consumers,
                        datasets: [{
                            label: 'Escenarios Procesados',
                            data: results,
                            backgroundColor: consumers.map((_, i) => 
                                `hsl(${i * 360 / consumers.length}, 70%, 60%)`
                            ),
                            borderColor: consumers.map((_, i) => 
                                `hsl(${i * 360 / consumers.length}, 70%, 40%)`
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Escenarios Procesados'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Consumidores'
                                }
                            }
                        }
                    }
                });
            } else {
                consumerChart.data.labels = consumers;
                consumerChart.data.datasets[0].data = results;
                consumerChart.data.datasets[0].backgroundColor = consumers.map((_, i) => 
                    `hsl(${i * 360 / consumers.length}, 70%, 60%)`
                );
                consumerChart.data.datasets[0].borderColor = consumers.map((_, i) => 
                    `hsl(${i * 360 / consumers.length}, 70%, 40%)`
                );
                consumerChart.update();
            }
        }

        function updateConsumerTable(data) {
            const table = document.getElementById('consumerTable').querySelector('tbody');
            table.innerHTML = '';
            
            for (const [consumerId, stats] of Object.entries(data.consumer_stats)) {
                const row = table.insertRow();
                row.insertCell(0).textContent = consumerId;
                row.insertCell(1).textContent = stats.host || 'N/A';
                row.insertCell(2).textContent = Math.round(stats.active_time);
                row.insertCell(3).textContent = stats.results_count;
                row.insertCell(4).textContent = typeof stats.last_result === 'number' 
                    ? stats.last_result.toFixed(4) 
                    : stats.last_result;
                row.insertCell(5).textContent = new Date(stats.last_activity * 1000).toLocaleTimeString();
            }
        }

        function updateBitacoraTable(data) {
            const table = document.getElementById('bitacoraTable').querySelector('tbody');
            table.innerHTML = '';
            
            // Mostrar los últimos registros de la bitácora
            data.scenario_history.forEach(entry => {
                const row = table.insertRow();
                row.insertCell(0).textContent = entry.time_str;
                row.insertCell(1).textContent = entry.consumer_id;
                row.insertCell(2).textContent = entry.host || 'N/A';
                row.insertCell(3).textContent = typeof entry.result === 'number' 
                    ? entry.result.toFixed(4) 
                    : entry.result;
                
                // Formatear variables del escenario
                const scenarioStr = Object.entries(entry.scenario)
                    .map(([key, value]) => `${key}: ${typeof value === 'number' ? value.toFixed(2) : value}`)
                    .join(', ');
                row.insertCell(4).textContent = scenarioStr;
            });
        }

        // Mostrar la pestaña de progreso por defecto
        showTab('progress');
    </script>
</body>
</html>